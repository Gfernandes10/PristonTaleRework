name: Unreal Engine CI/CD

# When to execute the workflow
on:
  push:
    branches: [ Stage, master ]  # Quando algu√©m fizer push
  pull_request:
    branches: [ master ]

#Global Variables
env:
  UE_VERSION: "5.6"  # Unreal Engine version
  UE_ROOT: "D:\\UE_5.6"
  PROJECT_NAME: "PristonTaleRework"
  PROJECT_PATH: "${{ github.workspace }}\\PristonTaleRework.uproject"

#task lists
jobs:
  #Job1: Quick Validation (Could be free runner)
  validate:
    name: Validate Code
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Download Code
      uses: actions/checkout@v4

    - name: Verificar Sintaxe C++
      run: |
        Write-Host "Verifying C++ files..."
        
        # Verify if there are .h/.cpp files
        $cppFiles = Get-ChildItem -Path "Source" -Include *.cpp,*.h -Recurse
        
        if ($cppFiles.Count -eq 0) {
          Write-Error "No C++ files found!"
          exit 1
        }
        
        Write-Host "Found $($cppFiles.Count) C++ files"
        
        # Check common syntax errors
        foreach ($file in $cppFiles) {
          $content = Get-Content $file.FullName -Raw
          
          # Example: check if all braces are closed
          $openBraces = ($content | Select-String -Pattern '\{' -AllMatches).Matches.Count
          $closeBraces = ($content | Select-String -Pattern '\}' -AllMatches).Matches.Count
          
          if ($openBraces -ne $closeBraces) {
            Write-Warning "Possible syntax error in: $($file.Name)"
          }
        }
        
        Write-Host "‚úÖ Basic validation completed"
    
    - name: Verify Project Structure
      run: |
        Write-Host "Verifying structure..."
        
        # Verify if essential files exist
        $requiredFiles = @(
          "PristonTaleRework.uproject",
          "Source/PristonTaleRework/PristonTaleRework.Build.cs"
        )
        
        foreach ($file in $requiredFiles) {
          if (-Not (Test-Path $file)) {
            Write-Error "Required file not found: $file"
            exit 1
          }
        }
        
        Write-Host "‚úÖ Project structure OK"

  #Job2: Complete compilation (needs host PC with Unreal Engine installed)
  build:
    name: Compile Project
    needs: validate
    runs-on: self-hosted  # Requires self-hosted runner with Unreal Engine installed
    timeout-minutes: 120

    steps:
    #Step 1: Download Code
    - name: Download Code
      uses: actions/checkout@v4
      with:
        lfs: true  # Enable Git LFS if using large files
        submodules: recursive  # Checkout submodules if any

    #Step 2: Download large asstes (Git LFS 
    - name: Pull LFS Assets
      shell: powershell
      run: git lfs pull

    #Step 3: Clean old builds
    - name: Clean Old Builds
      shell: powershell
      run: |
        Write-Host "Cleaning old builds..."
        
        # Remove Build folder
        if (Test-Path "Build") {
          Remove-Item -Path "Build" -Recurse -Force
          Write-Host "‚úÖ Build folder removed"
        }
        
        # Remove Binaries folder
        if (Test-Path "Binaries") {
          Remove-Item -Path "Binaries" -Recurse -Force
          Write-Host "‚úÖ Binaries folder removed"
        }
        
        # Remove Intermediate folder
        if (Test-Path "Intermediate") {
          Remove-Item -Path "Intermediate" -Recurse -Force
          Write-Host "‚úÖ Intermediate folder removed"
        }

    #Step 4: Compile Unreal Project
    - name: Compile Unreal Project
      shell: powershell
      run: |
        Write-Host "Starting compilation..."
        Write-Host "Project: $env:PROJECT_PATH"
        
        & "$env:UE_ROOT\Engine\Build\BatchFiles\Build.bat" `
          PristonTaleReworkEditor `
          Win64 `
          Development `
          -Project="$env:PROJECT_PATH" `
          -WaitMutex `
          -FromMsBuild
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "‚ùå Compilation failed!"
          exit 1
        }
        
        Write-Host "‚úÖ Compilation completed!"

    #Step 5: Pre-compile Shaders
    - name: Pre-Compile Shaders
      shell: powershell
      run: |
        Write-Host "üî® Pre-compiling shaders..."

        & "$env:UE_ROOT\Engine\Binaries\Win64\UnrealEditor-Cmd.exe" `
          "$env:PROJECT_PATH" `
          -run=DerivedDataCache `
          -fill `
          -NullRHI `
          -Unattended `
          -Log

        Write-Host "‚úÖ Shaders pre-compiled"

    #Step 5: Execute automated tests (if any)
    - name: Run Automated Tests
      shell: powershell
      continue-on-error: true
      run: |
        Write-Host "Running automated tests..."
        
        # Clean previous log
        $logPath = "Saved\Logs\PristonTaleRework.log"
        if (Test-Path $logPath) {
          Remove-Item $logPath -Force
        }

        $process = Start-Process `
          -FilePath "$env:UE_ROOT\Engine\Binaries\Win64\UnrealEditor-Cmd.exe" `
          -ArgumentList @(
            "`"$env:PROJECT_PATH`"",
            "-ExecCmds=`"Automation RunTests Now System+Project`"",
            "-TestExit=`"Automation Test Queue Empty`"",
            "-ReportOutputPath=`"${{ github.workspace }}\TestResults`"",
            "-NullRHI",
            "-Unattended",
            "-NoSplash",
            "-Log"
          ) `
          -PassThru `
          -NoNewWindow

        # Monitorar por 5 minutos
        $timeout = 300  # 5 minutos
        $elapsed = 0
        $lastLogSize = 0

        Write-Host "Monitoring test execution..."

        while (!$process.HasExited -and $elapsed -lt $timeout) {
          Start-Sleep -Seconds 10
          $elapsed += 10

          # Verificar se log est√° crescendo
          if (Test-Path $logPath) {
            $currentSize = (Get-Item $logPath).Length

            if ($currentSize -gt $lastLogSize) {
              Write-Host "‚è≥ Running... ($elapsed s) - Log size: $([math]::Round($currentSize/1KB, 2)) KB"
              $lastLogSize = $currentSize
            } else {
              Write-Host "‚ö†Ô∏è Log not growing for 10s... ($elapsed s elapsed)"
            }

            # Mostrar √∫ltima linha com "LogAutomation"
            $lastLines = Get-Content $logPath -Tail 50
            $automationLine = $lastLines | Where-Object { $_ -match "LogAutomation" } | Select-Object -Last 1

            if ($automationLine) {
              Write-Host "  ‚Üí $automationLine"
            }
          } else {
            Write-Host "‚è≥ Waiting for log file... ($elapsed s)"
          }
        }

        # Verificar se terminou ou timeout
        if (!$process.HasExited) {
          Write-Host "`n‚ö†Ô∏è Tests did not complete in $timeout seconds"
          Write-Host "Killing UnrealEditor-Cmd process..."

          # Matar processo
          Stop-Process -Id $process.Id -Force -ErrorAction SilentlyContinue

          # Matar processos filhos tamb√©m
          Get-Process | Where-Object { $_.ProcessName -like "*Unreal*" } | Stop-Process -Force -ErrorAction SilentlyContinue

          Write-Host "‚ùå Tests timed out"
          exit 1
        }

        # Verificar exit code
        $exitCode = $process.ExitCode

        if ($exitCode -eq 0) {
          Write-Host "`n‚úÖ Tests completed successfully!"
        } else {
          Write-Host "`n‚ùå Tests failed with exit code $exitCode"

          # Mostrar √∫ltimas 30 linhas do log
          if (Test-Path $logPath) {
            Write-Host "`nLast 30 lines of log:"
            Get-Content $logPath -Tail 30
          }

          exit 1
        }
        
        Write-Host "‚úÖ Tests completed!"

    #Step 6: Upload test results
    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ github.sha }}
        path: TestResults/
        retention-days: 7
  #Job3: Deployment (optional, can be added later)
  package:
    name: Package Project
    needs: build
    if: github.ref == 'refs/heads/Stage'
    runs-on: self-hosted
    timeout-minutes: 180

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        lfs: true
        submodules: recursive

    - name : Pull LFS Assets
      shell: powershell
      run: git lfs pull
    
    - name: Create Build Shipping
      run: |
        Write-Host "üì¶ Creating final build..."
        
        & "$env:UE_ROOT\Engine\Build\BatchFiles\RunUAT.bat" `
          BuildCookRun `
          -project="$env:PROJECT_PATH" `
          -platform=Win64 `
          -clientconfig=Shipping `
          -serverconfig=Shipping `
          -cook `
          -build `
          -stage `
          -pak `
          -archive `
          -archivedirectory="${{ github.workspace }}\Build" `
          -utf8output `
          -noP4
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "‚ùå Packaging failed!"
          exit 1
        }
        
        Write-Host "‚úÖ Build created successfully!"
    
    - name: Upload Final Build
      uses: actions/upload-artifact@v4
      with:
        name: PristonTaleRework-Win64-${{ github.sha }}
        path: Build/WindowsNoEditor/
        retention-days: 30
        compression-level: 6