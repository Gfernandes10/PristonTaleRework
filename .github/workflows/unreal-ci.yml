name: Unreal Engine CI/CD

# When to execute the workflow
on:
  push:
    branches: [ Stage, master ]  # Quando algu√©m fizer push
  pull_request:
    branches: [ master ]

#Global Variables
env:
  UE_VERSION: "5.6"  # Unreal Engine version
  UE_ROOT: "D:\\UE_5.6"
  PROJECT_NAME: "PristonTaleRework"
  PROJECT_PATH: "${{ github.workspace }}\\PristonTaleRework.uproject"

#task lists
jobs:
  #Job1: Quick Validation (Could be free runner)
  validate:
    name: Validate Code
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Download Code
      uses: actions/checkout@v4

    - name: Verificar Sintaxe C++
      run: |
        Write-Host "Verifying C++ files..."
        
        # Verify if there are .h/.cpp files
        $cppFiles = Get-ChildItem -Path "Source" -Include *.cpp,*.h -Recurse
        
        if ($cppFiles.Count -eq 0) {
          Write-Error "No C++ files found!"
          exit 1
        }
        
        Write-Host "Found $($cppFiles.Count) C++ files"
        
        # Check common syntax errors
        foreach ($file in $cppFiles) {
          $content = Get-Content $file.FullName -Raw
          
          # Example: check if all braces are closed
          $openBraces = ($content | Select-String -Pattern '\{' -AllMatches).Matches.Count
          $closeBraces = ($content | Select-String -Pattern '\}' -AllMatches).Matches.Count
          
          if ($openBraces -ne $closeBraces) {
            Write-Warning "Possible syntax error in: $($file.Name)"
          }
        }
        
        Write-Host " Basic validation completed"
    
    - name: Verify Project Structure
      run: |
        Write-Host "Verifying structure..."
        
        # Verify if essential files exist
        $requiredFiles = @(
          "PristonTaleRework.uproject",
          "Source/PristonTaleRework/PristonTaleRework.Build.cs"
        )
        
        foreach ($file in $requiredFiles) {
          if (-Not (Test-Path $file)) {
            Write-Error "Required file not found: $file"
            exit 1
          }
        }
        
        Write-Host " Project structure OK"

  #Job2: Complete compilation (needs host PC with Unreal Engine installed)
  build:
    name: Compile Project
    needs: validate
    runs-on: self-hosted  # Requires self-hosted runner with Unreal Engine installed
    timeout-minutes: 120

    steps:
    #Step 1: Download Code
    - name: Download Code
      uses: actions/checkout@v4
      with:
        lfs: true  # Enable Git LFS if using large files
        submodules: recursive  # Checkout submodules if any

    #Step 2: Download large asstes (Git LFS 
    - name: Pull LFS Assets
      shell: powershell
      run: git lfs pull

    #Step 3: Clean old builds
    - name: Clean Old Builds
      shell: powershell
      run: |
        Write-Host "Cleaning old builds..."
        
        # Remove Build folder
        if (Test-Path "Build") {
          Remove-Item -Path "Build" -Recurse -Force
          Write-Host " Build folder removed"
        }
        
        # Remove Binaries folder
        if (Test-Path "Binaries") {
          Remove-Item -Path "Binaries" -Recurse -Force
          Write-Host " Binaries folder removed"
        }
        
        # Remove Intermediate folder
        if (Test-Path "Intermediate") {
          Remove-Item -Path "Intermediate" -Recurse -Force
          Write-Host " Intermediate folder removed"
        }

    #Step 4: Compile Unreal Project
    - name: Compile Unreal Project
      shell: powershell
      run: |
        Write-Host "Starting compilation..."
        Write-Host "Project: $env:PROJECT_PATH"
        
        & "$env:UE_ROOT\Engine\Build\BatchFiles\Build.bat" `
          PristonTaleReworkEditor `
          Win64 `
          Development `
          -Project="$env:PROJECT_PATH" `
          -WaitMutex `
          -FromMsBuild
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error " Compilation failed!"
          exit 1
        }
        
        Write-Host " Compilation completed!"

    # - name: Run System Tests
    #   timeout-minutes: 3
    #   shell: powershell
    #   continue-on-error: true
    #   run: |
    #     Write-Host "[TESTS] Starting system tests (no shaders)..."

    #     & "$env:UE_ROOT\Engine\Binaries\Win64\UnrealEditor-Cmd.exe" `
    #       "$env:PROJECT_PATH" `
    #       -ExecCmds="Automation RunTests Now System" `
    #       -TestExit="Automation Test Queue Empty" `
    #       -ReportOutputPath="${{ github.workspace }}\TestResults" `
    #       -NullRHI `
    #       -NoShaderCompile `
    #       -NoPause `
    #       -Unattended `
    #       -NoSplash `
    #       -Log=Log.txt `
    #       -Verbose

    #     Write-Host "`n[LOG] Last 50 lines of log:"
    #     Get-Content "Saved\Logs\PristonTaleRework.log" -Tail 50

    #     if ($LASTEXITCODE -eq -1073741571) {
    #       Write-Host "`n[ERROR] Stack overflow detected!"
    #       Write-Host "This usually indicates:"
    #       Write-Host "  - Infinite recursion in C++ code"
    #       Write-Host "  - Blueprint infinite loop"
    #       Write-Host "  - GAS callback loop"

    #       # Procurar por "Stack:" no log
    #       Write-Host "`n[CALLSTACK] Searching for crash info:"
    #       Get-Content "Saved\Logs\PristonTaleRework.log" | Select-String -Pattern "Stack:|Assertion|Fatal"

    #       exit 1
    #     }

    #     if ($LASTEXITCODE -ne 0) {
    #       Write-Host "[WARNING] Tests failed with exit code: $LASTEXITCODE"
    #       exit 1
    #     }

    #     Write-Host "[OK] Tests passed"

    # - name: Upload Test Results
    #   if: always()
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: test-results-${{ github.sha }}
    #     path: |
    #       TestResults/
    #       Saved/Logs/
    #     retention-days: 7

    # - name: Display Summary
    #   if: always()
    #   shell: powershell
    #   run: |
    #     Write-Host ""
    #     Write-Host "================================"
    #     Write-Host "Build Summary"
    #     Write-Host "================================"
    #     Write-Host "Branch:  ${{ github.ref_name }}"
    #     Write-Host "Commit:  ${{ github.sha }}"

    #     $reportPath = "TestResults\index.json"

    #     if (Test-Path $reportPath) {
    #       $report = Get-Content $reportPath -Raw | ConvertFrom-Json

    #       Write-Host "Tests:   $($report.totalTests)"
    #       Write-Host "Passed:  $($report.passed)"
    #       Write-Host "Failed:  $($report.failed)"
    #     }

    #     Write-Host "================================"

  #Job3: Deployment (optional, can be added later)
  package:
    name: Package Project
    needs: build
    if: github.ref == 'refs/heads/Stage'
    runs-on: self-hosted
    timeout-minutes: 180

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        lfs: true
        submodules: recursive

    - name : Pull LFS Assets
      shell: powershell
      run: git lfs pull
    
    - name: Create Build Shipping
      run: |
        Write-Host " Creating final build..."
        
        & "$env:UE_ROOT\Engine\Build\BatchFiles\RunUAT.bat" `
          BuildCookRun `
          -project="$env:PROJECT_PATH" `
          -platform=Win64 `
          -clientconfig=Shipping `
          -serverconfig=Shipping `
          -cook `
          -build `
          -stage `
          -pak `
          -archive `
          -archivedirectory="${{ github.workspace }}\Build" `
          -utf8output `
          -noP4
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error " Packaging failed!"
          exit 1
        }
        
        Write-Host " Build created successfully!"
    
    - name: Upload Final Build
      uses: actions/upload-artifact@v4
      with:
        name: PristonTaleRework-Win64-${{ github.sha }}
        path: Build/WindowsNoEditor/
        retention-days: 30
        compression-level: 6